<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Soldier Fly Larvae Monitoring Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #9e9fa0ff;
            color: #333;
            overflow-x: auto;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            min-width: 320px;
        }

        header {
            background-color: #2980b9;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo {
            height: 50px;
            width: auto;
            border-radius: 30%;
            object-fit: cover;
        }

        h1 {
            margin: 0;
            font-size: 24px;
            color: white;
        }

        .controls-section {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 90px;
            z-index: 90;
        }

        .tray-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            overflow-x: auto;
            padding-bottom: 5px;
        }

        .tray-selector::-webkit-scrollbar {
            height: 6px;
        }

        .tray-selector::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .tray-selector::-webkit-scrollbar-thumb {
            background: #bdc3c7;
            border-radius: 3px;
        }

        .tray-btn, .chart-toggle-btn {
            padding: 10px 20px;
            background-color: #ecf0f1;
            border: 2px solid #bdc3c7;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            text-align: center;
            min-width: 120px;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .tray-btn:hover, .chart-toggle-btn:hover {
            background-color: #dcdfe4;
            border-color: #aeb6bf;
            transform: translateY(-2px);
        }

        .tray-btn.active {
            background-color: #27ae60;
            color: white;
            border-color: #27ae60;
            box-shadow: 0 4px 8px rgba(39, 174, 96, 0.3);
        }

        .chart-toggle-group {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .chart-toggle-btn.active {
            background-color: #3498db;
            color: white;
            border-color: #3498db;
            box-shadow: 4px 8px rgba(52, 152, 219, 0.3);
        }

        .comparison-btn {
            background-color: #bfe3faff;
            color: black;
            border-color: #78b2daff;
        }

        .comparison-btn:hover {
            background-color: #2980b9;
            border-color: #2980b9;
        }

        .comparison-btn.active {
            background-color: #2980b9;
            border-color: #2980b9;
            color: white;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .metric-card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            text-align: center;
            transition: transform 0.3s ease;
        }

        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }

        .metric-value {
            font-size: 28px;
            font-weight: bold;
            margin: 10px 0;
            color: #2c3e50;
        }

        .metric-label {
            color: #7f8c8d;
            font-size: 14px;
            text-transform: uppercase;
            font-weight: 600;
        }

        .unit {
            font-size: 16px;
            color: #7f8c8d;
        }

        .image-classification-section {
            margin-bottom: 30px;
        }

        .chart-header {
            background-color: #f8f9fa;
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .image-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .refresh-btn {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: background-color 0.3s;
        }

        .refresh-btn:hover {
            background-color: #218838;
        }

        .refresh-icon {
            font-size: 16px;
            transition: transform 0.3s;
        }

        .refresh-btn:hover .refresh-icon {
            transform: rotate(90deg);
        }

        #trayFilter {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: white;
            font-size: 14px;
            cursor: pointer;
        }

        .images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            padding: 20px 0;
            min-height: 300px;
        }

        .image-item {
            background-color: #f9f9f9;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .image-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
        }

        .image-wrapper {
            position: relative;
            overflow: hidden;
        }

        .image-wrapper img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .image-item:hover .image-wrapper img {
            transform: scale(1.05);
        }

        .image-overlay {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            align-items: flex-end;
        }

        .classification-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .classification-badge.healthy {
            background-color: #28a745;
            color: white;
        }

        .classification-badge.warning {
            background-color: #ffc107;
            color: #212529;
        }

        .classification-badge.critical {
            background-color: #dc3545;
            color: white;
        }

        .confidence-score {
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 3px 6px;
            border-radius: 8px;
            font-size: 10px;
            font-weight: bold;
        }

        .image-info {
            padding: 15px;
        }

        .image-title {
            font-weight: bold;
            font-size: 16px;
            color: #2c3e50;
            margin-bottom: 8px;
        }

        .image-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-size: 12px;
            color: #666;
        }

        .timestamp {
            font-weight: 500;
        }

        .larvae-count {
            background-color: #e9ecef;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 500;
        }

        .classification-metrics {
            display: flex;
            justify-content: space-between;
            gap: 10px;
        }

        .metric {
            font-size: 11px;
            color: #495057;
            background-color: #f8f9fa;
            padding: 3px 6px;
            border-radius: 4px;
            flex: 1;
            text-align: center;
        }

        .pagination-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            padding: 20px 0;
            border-top: 1px solid #e9ecef;
            margin-top: 20px;
        }

        .pagination-btn {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }

        .pagination-btn:hover {
            background-color: #0056b3;
        }

        .pagination-btn:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }

        .page-info {
            font-size: 14px;
            color: #666;
            font-weight: 500;
        }

        .charts-section {
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
        }

        .chart-container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .chart-header {
            background-color: #f8f9fa;
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
        }

        .chart-title {
            margin: 0;
            color: #2c3e50;
            font-size: 20px;
            font-weight: 600;
            text-align: center;
        }

        .chart-content {
            padding: 20px;
            position: relative;
        }

        .chart-canvas-wrapper {
            position: relative;
            height: 400px;
            margin-bottom: 20px;
        }

        .comparison-view .chart-canvas-wrapper {
            height: 500px;
        }

        .chart-legend {
            max-height: 120px;
            overflow-y: auto;
            overflow-x: hidden;
            border-top: 1px solid #e9ecef;
            padding-top: 15px;
            margin-top: 15px;
        }

        .chart-legend::-webkit-scrollbar {
            width: 6px;
        }

        .chart-legend::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .chart-legend::-webkit-scrollbar-thumb {
            background: #bdc3c7;
            border-radius: 3px;
        }

        .legend-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 8px;
            padding: 10px 0;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 5px 8px;
            border-radius: 4px;
            font-size: 12px;
            background-color: #f8f9fa;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
            flex-shrink: 0;
        }

        .legend-dash {
            width: 16px;
            height: 2px;
            border-radius: 1px;
            flex-shrink: 0;
        }

        .update-time {
            font-size: 14px;
            color: #000000ff;
            text-align: right;
            white-space: nowrap;
        }

        .comparison-view .chart-title {
            color: #9b59b6;
            font-weight: bold;
        }

        .loading-indicator {
            display: none;
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        .loading-indicator.show {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 1200px) {
            .charts-section {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .controls-section {
                padding: 15px;
            }
            
            .tray-btn, .chart-toggle-btn {
                min-width: 100px;
                padding: 8px 16px;
                font-size: 14px;
            }
            
            .header-left {
                flex-direction: column;
                align-items: center;
                gap: 10px;
            }
            
            .logo {
                height: 40px;
            }
            
            h1 {
                font-size: 18px;
                text-align: center;
            }
            
            .update-time {
                display: none;
            }
            
            header {
                flex-direction: column;
                align-items: center;
                padding: 15px;
            }
            
            .metric-value {
                font-size: 24px;
            }
            
            .chart-canvas-wrapper {
                height: 300px;
            }
            
            .comparison-view .chart-canvas-wrapper {
                height: 350px;
            }
            
            .legend-grid {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            }
        }

        @media (max-width: 480px) {
            .metrics-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }
            
            .tray-btn, .chart-toggle-btn {
                min-width: 80px;
                padding: 6px 12px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-left">
                <img src="/static/blackflyLogo.jpeg" alt="Black Soldier Fly Logo" class="logo">
                <h1>Black Soldier Fly Larvae Monitoring Dashboard</h1>
            </div>
            <div class="update-time">Last updated: <span id="update-time"></span></div>
        </header>

        <div class="controls-section">
            <div class="tray-selector" id="tray-selector">
                {% for tray_num, data in tray_data.items() %}
                <button class="tray-btn" data-tray-number="{{ tray_num }}">Tray #{{ tray_num }}</button>
                {% endfor %}
                <button class="tray-btn" data-tray-number="0">Combined Trays</button>
                <button class="tray-btn comparison-btn" data-tray-number="4">Compare All Trays</button>
            </div>

            <div class="chart-toggle-group">
                <button class="chart-toggle-btn active" data-chart-mode="both">Length & Weight</button>
                <button class="chart-toggle-btn" data-chart-mode="length">Length Only</button>
                <button class="chart-toggle-btn" data-chart-mode="weight">Weight Only</button>
            </div>
        </div>

        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-label">Average Length</div>
                <div class="metric-value" id="length">0 <span class="unit">mm</span></div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Average Width</div>
                <div class="metric-value" id="width">0 <span class="unit">mm</span></div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Average Area</div>
                <div class="metric-value" id="area">0 <span class="unit">mm²</span></div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Average Weight</div>
                <div class="metric-value" id="weight">0 <span class="unit">mg</span></div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Total Count</div>
                <div class="metric-value" id="count">0</div>
            </div>
        </div>

        <div class="image-section">
            <div class="section">
                <div style ="display: flex; justify-content: space-between; align-items: center;">
                    <h2 class="chart-title">Classified Images</h2>
                    <div class="controls">
                        <button class="refresh-btn" onclick="refreshImages()">
                            <span class="refresh-icon">↻</span> Refresh
                        </button>
                        <select id="trayFilter" onchange="filterImages()">
                            <option value="all">All Trays</option>
                            {% for tray_num, data in tray_data.items() %}
                            <option value="{{ tray_num }}">Tray {{ tray_num }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="chart-content">
                    <div class="loading-indicator" id="imagesLoading">
                        <div class="spinner"></div>
                        <div>Loading classified images...</div>
                    </div>
                    <div class="images-grid" id="imagesGrid">
                        </div>
                    <div class="pagination-controls">
                        <button class="pagination-btn" onclick="previousPage()" id="prevBtn">← Previous</button>
                        <span class="page-info">Page <span id="currentPage">1</span> of <span id="totalPages">3</span></span>
                        <button class="pagination-btn" onclick="nextPage()" id="nextBtn">Next →</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="charts-section">
            <div class="chart-container" id="growthChartContainer">
                <div class="chart-header">
                    <h3 class="chart-title" id="growthChartTitle">Growth Trend (Over Days)</h3>
                </div>
                <div class="chart-content">
                    <div class="loading-indicator" id="growthLoading">
                        <div class="spinner"></div>
                        <div>Loading chart data...</div>
                    </div>
                    <div class="chart-canvas-wrapper">
                        <canvas id="growthChart"></canvas>
                    </div>
                    <div class="chart-legend" id="growthLegend"></div>
                </div>
            </div>
            
            <div class="chart-container" id="weightChartContainer">
                <div class="chart-header">
                    <h3 class="chart-title" id="weightChartTitle">Weight Distribution</h3>
                </div>
                <div class="chart-content">
                    <div class="loading-indicator" id="weightLoading">
                        <div class="spinner"></div>
                        <div>Loading chart data...</div>
                    </div>
                    <div class="chart-canvas-wrapper">
                        <canvas id="weightChart"></canvas>
                    </div>
                    <div class="chart-legend" id="weightLegend"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let growthChart;
        let weightChart;
        let currentSelectedTray = null;
        let currentGrowthData = {};
        let currentWeightDistribution = {}; 
        let currentComparisonData = {};
        let currentChartMode = 'both';
        let trayColors = {};
        
        // Data for classified images
        let allImagesData = [];
        let filteredImages = [];
        let currentPage = 1;
        const imagesPerPage = 4;

        // Dynamic color generation for trays
        function generateTrayColors(trayNumbers) {
            const colors = {
                0: '#f39c12', // Orange for combined
                4: '#9b59b6'  // Purple for comparison
            };
            
            const presetColors = ['#228B22', '#00CED1', '#4B0082', '#FFD700', '#DC143C', '#1ABC9C', '#34495E', '#95A5A6', '#D35400', '#C0392B'];
            
            trayNumbers.forEach((trayNum, index) => {
                if (trayNum !== 0 && trayNum !== 4 && !colors[trayNum]) {
                    colors[trayNum] = index < presetColors.length ? presetColors[index] : 
                        `#${Math.floor(Math.random()*16777215).toString(16).padStart(6, '0')}`;
                }
            });
            
            return colors;
        }

        function showLoading(chartType) {
            document.getElementById(`${chartType}Loading`).classList.add('show');
        }

        function hideLoading(chartType) {
            document.getElementById(`${chartType}Loading`).classList.remove('show');
        }

        function createCustomLegend(datasets, containerId, chartMode) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            if (!datasets || datasets.length === 0) return;
            
            const legendGrid = document.createElement('div');
            legendGrid.className = 'legend-grid';
            
            datasets.forEach(dataset => {
                const legendItem = document.createElement('div');
                legendItem.className = 'legend-item';
                
                const colorIndicator = document.createElement('div');
                if (dataset.borderDash && dataset.borderDash.length > 0) {
                    colorIndicator.className = 'legend-dash';
                    colorIndicator.style.backgroundColor = dataset.borderColor;
                } else {
                    colorIndicator.className = 'legend-color';
                    colorIndicator.style.backgroundColor = dataset.borderColor;
                }
                
                const label = document.createElement('span');
                label.textContent = dataset.label;
                label.style.fontSize = '11px';
                label.style.fontWeight = '500';
                
                legendItem.appendChild(colorIndicator);
                legendItem.appendChild(label);
                legendGrid.appendChild(legendItem);
            });
            
            container.appendChild(legendGrid);
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', () => {
            const trayNumbers = Object.keys(trayData).map(Number);
            trayColors = generateTrayColors([0, ...trayNumbers, 4]);
            
            document.querySelectorAll('.tray-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const trayNumber = parseInt(button.dataset.trayNumber);
                    updateDashboard(trayNumber, currentChartMode);
                });
            
            const initialTray = trayNumbers.length > 0 ? trayNumbers[0] : 0;
            updateDashboard(initialTray, currentChartMode);
            });

            document.querySelectorAll('.chart-toggle-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const mode = button.dataset.chartMode;
                    updateDashboard(currentSelectedTray, mode);
                });
            });

            //loadClassifiedImages(); // Load classified images on startup
            filterImages(); // Initial filter and render

            const initialTray = trayNumbers.length > 0 ? trayNumbers[0] : 0;
            updateDashboard(initialTray, currentChartMode);
        });

        async function updateDashboard(trayNumber, chartMode = null) {
            try {
                showLoading('growth');
                showLoading('weight');
                showLoading('images');
                
                currentSelectedTray = trayNumber;
                if (chartMode) currentChartMode = chartMode;

                document.querySelectorAll('.tray-btn').forEach(btn => {
                    btn.classList.toggle('active', parseInt(btn.dataset.trayNumber) === trayNumber);
                });
                document.querySelectorAll('.chart-toggle-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.chartMode === currentChartMode);
                });

                const growthChartContainer = document.getElementById('growthChartContainer');
                const weightChartContainer = document.getElementById('weightChartContainer');
                let data;

                if (trayNumber === 4) {
                    const response = await fetch('/api/compare-data');
                    data = await response.json();
                    growthChartContainer.classList.add('comparison-view');
                    weightChartContainer.classList.add('comparison-view');
                    document.getElementById('growthChartTitle').textContent = 'Growth Trend Comparison (All Trays)';
                    document.getElementById('weightChartTitle').textContent = 'Weight Distribution Comparison (All Trays)';
                    
                    currentComparisonData = sampleComparisonData;
                    updateComparisonCharts(currentComparisonData.trays, currentChartMode);
                    updateMetricsDisplay(calculateAverageMetrics(currentComparisonData.trays));
                    document.getElementById('update-time').textContent = new Date(currentComparisonData.timestamp).toLocaleString();
                    allImagesData = data.images || []; 
                    filterImages();
                } else {
                    const response = await fetch(`/api/tray-data?tray_number=${trayNumber}`);
                    data = await response.json();
                    growthChartContainer.classList.remove('comparison-view');
                    weightChartContainer.classList.remove('comparison-view');
                    
                    const isCombined = trayNumber === 0;
                    document.getElementById('growthChartTitle').textContent = isCombined ? 
                        'Combined Growth Trend' : `Growth Trend - Tray ${trayNumber}`;
                    document.getElementById('weightChartTitle').textContent = isCombined ? 
                        'Combined Weight Distribution' : `Weight Distribution - Tray ${trayNumber}`;

                    currentGrowthData = data.growthData || { days: [], length: [], weight: [] };
                    currentWeightDistribution = data.allWeights || [];

                    updateMetricsDisplay(data.metrics || { length: 0, width: 0, area: 0, weight: 0, count: 0 });
                    document.getElementById('update-time').textContent = data.timestamp ? 
                        new Date(sampleData.timestamp).toLocaleString() : 'N/A';

                    updateGrowthChart(currentGrowthData, trayNumber, currentChartMode);
                    updateWeightChart(currentWeightDistribution, trayNumber);
                    allImagesData = data.images || []; 
                    filterImages();
                }
                
                hideLoading('growth');
                hideLoading('weight');
                hideLoading('images');
            } catch (error) {
                console.error('Error updating dashboard:', error);
                hideLoading('growth');
                hideLoading('weight');
                hideLoading('images');
                updateMetricsDisplay({ length: 0, width: 0, area: 0, weight: 0, count: 0 });
                updateGrowthChart({ days: [], length: [], weight: [] }, currentSelectedTray, currentChartMode);
                updateWeightChart([], currentSelectedTray);
                document.getElementById('update-time').textContent = 'Error loading data';
                document.getElementById('imagesGrid').innerHTML = '<div style="text-align: center; color: #7f8c8d; padding: 20px;">Error loading images.</div>';
            }
        }

        function refreshImages() {
            // This function will now simply call the main update function again
            // to reload all data, including images.
            updateDashboard(currentSelectedTray, currentChartMode);
        }

        function updateMetricsDisplay(metrics) {
            document.getElementById('length').innerHTML = metrics.length.toFixed(1) + ' <span class="unit">mm</span>';
            document.getElementById('width').innerHTML = metrics.width.toFixed(1) + ' <span class="unit">mm</span>';
            document.getElementById('area').innerHTML = metrics.area.toFixed(1) + ' <span class="unit">mm²</span>';
            document.getElementById('weight').innerHTML = metrics.weight.toFixed(1) + ' <span class="unit">mg</span>';
            document.getElementById('count').innerHTML = metrics.count.toLocaleString();
        }

        function calculateAverageMetrics(traysData) {
            let totalLength = 0, totalWidth = 0, totalArea = 0, totalWeight = 0, totalCount = 0;
            let actualTraysCounted = 0;

            for (const trayNum in traysData) {
                if (traysData[trayNum] && traysData[trayNum].latest && traysData[trayNum].latest.count > 0) {
                    totalLength += traysData[trayNum].latest.length;
                    totalWidth += traysData[trayNum].latest.width;
                    totalArea += traysData[trayNum].latest.area;
                    totalWeight += traysData[trayNum].latest.weight;
                    totalCount += traysData[trayNum].latest.count;
                    actualTraysCounted++;
                }
            }

            if (actualTraysCounted === 0) {
                return { length: 0, width: 0, area: 0, weight: 0, count: 0 };
            }

            return {
                length: totalLength / actualTraysCounted,
                width: totalWidth / actualTraysCounted,
                area: totalArea / actualTraysCounted,
                weight: totalWeight / actualTraysCounted,
                count: totalCount
            };
        }

        function updateGrowthChart(data, currentTrayNumber, chartMode) {
            const ctx = document.getElementById('growthChart').getContext('2d');
            if (growthChart) {
                growthChart.destroy();
            }

            const borderColor = trayColors[currentTrayNumber] || '#3498db';
            const backgroundColor = `${borderColor}20`;

            const datasets = [];

            if (chartMode === 'both' || chartMode === 'length') {
                datasets.push({
                    label: `Length (mm) - Tray ${currentTrayNumber === 0 ? 'Combined' : currentTrayNumber}`,
                    data: data.length,
                    borderColor: borderColor,
                    backgroundColor: backgroundColor,
                    borderWidth: 3,
                    tension: 0.3,
                    yAxisID: 'y',
                    pointRadius: 4,
                    pointBackgroundColor: borderColor
                });
            }

            if (chartMode === 'both' || chartMode === 'weight') {
                datasets.push({
                    label: `Weight (mg) - Tray ${currentTrayNumber === 0 ? 'Combined' : currentTrayNumber}`,
                    data: data.weight,
                    borderColor: borderColor,
                    backgroundColor: backgroundColor,
                    borderWidth: 3,
                    tension: 0.3,
                    yAxisID: 'y1',
                    borderDash: [5, 5],
                    pointRadius: 4,
                    pointBackgroundColor: borderColor
                });
            }

            growthChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.days.map(day => `Day ${day}`),
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: (chartMode === 'both' || chartMode === 'length'),
                            position: 'left',
                            title: {
                                display: (chartMode === 'both' || chartMode === 'length'),
                                text: 'Length (mm)'
                            },
                            beginAtZero: true
                        },
                        y1: {
                            type: 'linear',
                            display: (chartMode === 'both' || chartMode === 'weight'),
                            position: 'right',
                            title: {
                                display: (chartMode === 'both' || chartMode === 'weight'),
                                text: 'Weight (mg)'
                            },
                            grid: {
                                drawOnChartArea: (chartMode === 'both' || chartMode === 'length')
                            },
                            beginAtZero: true
                        }
                    }
                }
            });
            createCustomLegend(datasets, 'growthLegend', chartMode);
        }

        function updateWeightChart(data, currentTrayNumber) {
            const ctx = document.getElementById('weightChart').getContext('2d');
            if (weightChart) {
                weightChart.destroy();
            }

            const borderColor = trayColors[currentTrayNumber] || '#3498db';
            const backgroundColor = `${borderColor}50`;

            // Function to generate histogram data from an array of numbers
            function getDensityData(weights) {
                if (weights.length === 0) return { labels: [], data: [] };
                
                const minWeight = Math.min(...weights);
                const maxWeight = Math.max(...weights);
                const binSize = 5; // You can adjust the bin size for different granularity
                const numBins = Math.ceil((maxWeight - minWeight) / binSize);
                
                const bins = new Array(numBins).fill(0);
                const labels = [];
                for (let i = 0; i < numBins; i++) {
                    const binStart = minWeight + i * binSize;
                    const binEnd = binStart + binSize;
                    labels.push(`${binStart.toFixed(0)}-${binEnd.toFixed(0)}`);
                }
                
                weights.forEach(weight => {
                    let binIndex = Math.floor((weight - minWeight) / binSize);
                    if (binIndex >= numBins) binIndex = numBins - 1; // Handle edge case for max value
                    if (binIndex >= 0 && binIndex < bins.length) {
                        bins[binIndex]++;
                    }
                });

                return { labels, data: bins };
            }

            const { labels, data: densityData } = getDensityData(data);

            weightChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: `Weight Density - Tray ${currentTrayNumber === 0 ? 'Combined' : currentTrayNumber}`,
                        data: densityData,
                        backgroundColor: backgroundColor,
                        borderColor: borderColor,
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Weight Range (mg)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Number of Larvae'
                            },
                            beginAtZero: true
                        }
                    }
                }
            });
            createCustomLegend(weightChart.data.datasets, 'weightLegend');
        }

        function updateComparisonCharts(traysData, chartMode) {
            const growthCtx = document.getElementById('growthChart').getContext('2d');
            if (growthChart) growthChart.destroy();
            
            const growthDatasets = [];
            
            for (const trayNum in traysData) {
                const data = traysData[trayNum].growthData;
                const borderColor = trayColors[trayNum] || '#000000';
                
                if (chartMode === 'both' || chartMode === 'length') {
                    growthDatasets.push({
                        label: `Length (mm) - Tray ${trayNum}`,
                        data: data.length,
                        borderColor: borderColor,
                        backgroundColor: `${borderColor}20`,
                        borderWidth: 3,
                        tension: 0.3,
                        yAxisID: 'y',
                        pointRadius: 3
                    });
                }
                
                if (chartMode === 'both' || chartMode === 'weight') {
                    growthDatasets.push({
                        label: `Weight (mg) - Tray ${trayNum}`,
                        data: data.weight,
                        borderColor: borderColor,
                        backgroundColor: `${borderColor}20`,
                        borderWidth: 3,
                        tension: 0.3,
                        yAxisID: 'y1',
                        borderDash: [5, 5],
                        pointRadius: 3
                    });
                }
            }
            
            const commonLabels = Array.from(new Set(Object.values(traysData).flatMap(t => t.growthData.days)))
                                     .sort((a, b) => a - b)
                                     .map(day => `Day ${day}`);
            
            growthChart = new Chart(growthCtx, {
                type: 'line',
                data: {
                    labels: commonLabels,
                    datasets: growthDatasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        y: {
                            type: 'linear',
                            display: (chartMode === 'both' || chartMode === 'length'),
                            position: 'left',
                            title: { display: (chartMode === 'both' || chartMode === 'length'), text: 'Length (mm)' },
                            beginAtZero: true
                        },
                        y1: {
                            type: 'linear',
                            display: (chartMode === 'both' || chartMode === 'weight'),
                            position: 'right',
                            title: { display: (chartMode === 'both' || chartMode === 'weight'), text: 'Weight (mg)' },
                            grid: { drawOnChartArea: (chartMode === 'both' || chartMode === 'length') },
                            beginAtZero: true
                        },
                        x: {
                            title: { display: true, text: 'Day' }
                        }
                    }
                }
            });
            createCustomLegend(growthDatasets, 'growthLegend');

            const weightCtx = document.getElementById('weightChart').getContext('2d');
            if (weightChart) weightChart.destroy();

            const allWeights = Object.values(traysData).flatMap(t => t.allWeights);
            const minWeight = Math.min(...allWeights);
            const maxWeight = Math.max(...allWeights);
            const binSize = 5;
            const labels = [];
            const bins = {};
            for (let i = minWeight; i <= maxWeight + binSize; i += binSize) {
                labels.push(`${i.toFixed(0)}-${(i + binSize).toFixed(0)}`);
                bins[i] = [];
            }
            
            for (const trayNum in traysData) {
                traysData[trayNum].allWeights.forEach(weight => {
                    const bin = Math.floor(weight / binSize) * binSize;
                    if (bins[bin]) {
                        bins[bin].push(weight);
                    }
                });
            }

            const weightDatasets = [];
            for (const trayNum in traysData) {
                const borderColor = trayColors[trayNum] || '#000000';
                const backgroundColor = `${borderColor}50`;
                
                const binnedData = Object.keys(bins).map(binStart => {
                    const binArray = traysData[trayNum].allWeights.filter(w => w >= binStart && w < (parseFloat(binStart) + binSize));
                    return binArray.length;
                });
                
                weightDatasets.push({
                    label: `Tray ${trayNum}`,
                    data: binnedData,
                    backgroundColor: backgroundColor,
                    borderColor: borderColor,
                    borderWidth: 1,
                    type: 'line',
                    fill: 'stack', // Stacked area chart for comparison
                    tension: 0.4,
                    pointRadius: 0
                });
            }

            weightChart = new Chart(weightCtx, {
                data: {
                    labels: labels,
                    datasets: weightDatasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            stacked: true,
                            title: { display: true, text: 'Weight Range (mg)' }
                        },
                        y: {
                            stacked: true,
                            title: { display: true, text: 'Number of Larvae' },
                            beginAtZero: true
                        }
                    }
                }
            });
            createCustomLegend(weightDatasets, 'weightLegend');
        }

        // Image functionality
        function refreshImages() {
            showLoading('images');
            // This function is now a placeholder.
            // Replace this with a call to fetch new classified image data.
            loadClassifiedImages();
            filterImages();
            hideLoading('images');
        }

        function filterImages() {
            const selectedTray = document.getElementById('trayFilter').value;
            if (selectedTray === 'all') {
                filteredImages = allImagesData;
            } else {
                filteredImages = allImagesData.filter(img => img.tray == selectedTray);
            }
            currentPage = 1;
            renderImagesGrid();
            updatePaginationControls();
        }

        function renderImagesGrid() {
            const grid = document.getElementById('imagesGrid');
            grid.innerHTML = '';
            
            const start = (currentPage - 1) * imagesPerPage;
            const end = start + imagesPerPage;
            const imagesToDisplay = filteredImages.slice(start, end);

            imagesToDisplay.forEach(image => {
                const imageItem = document.createElement('div');
                imageItem.className = 'image-item';
                imageItem.dataset.tray = image.tray;
                
                imageItem.innerHTML = `
                    <div class="image-wrapper">
                        <img src="${image.src}" alt="Classified Image">
                    </div>
                    <div class="image-info">
                        <div class="image-title">Tray ${image.tray} - Image ${image.id}</div>
                        <div class="image-details">
                            <span class="timestamp">${image.timestamp}</span>
                            <span class="larvae-count">Count: ${image.count}</span>
                        </div>
                        <div class="classification-metrics">
                            <span class="metric">Avg Length: ${image.avgLength}mm</span>
                            <span class="metric">Avg Weight: ${image.avgWeight}mg</span>
                        </div>
                    </div>
                `;
                grid.appendChild(imageItem);
            });
            if (imagesToDisplay.length === 0) {
                grid.innerHTML = '<div style="text-align: center; color: #7f8c8d; padding: 20px;">No images found for this tray.</div>';
            }
        }

        function updatePaginationControls() {
            const totalPages = Math.ceil(filteredImages.length / imagesPerPage);
            document.getElementById('currentPage').textContent = currentPage;
            document.getElementById('totalPages').textContent = totalPages > 0 ? totalPages : 1;
            document.getElementById('prevBtn').disabled = currentPage === 1;
            document.getElementById('nextBtn').disabled = currentPage >= totalPages;
        }

        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                renderImagesGrid();
                updatePaginationControls();
            }
        }

        function nextPage() {
            const totalPages = Math.ceil(filteredImages.length / imagesPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                renderImagesGrid();
                updatePaginationControls();
            }
        }
    </script>z
</body>
</html>